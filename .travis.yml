language: python
dist: xenial
cache: pip

python:
- 3.6
- 3.5

install: pip install -r requirements.txt
script: pytest

stages:
- name: quality
- name: test
- name: docs
  if: branch = master AND tag =~ /^Release.*$/

jobs:
  include:
  - name: Test and coverage with Python 3.7 on Linux
    python: 3.7
    install:
    - pip install -r requirements.txt
    - pip install codecov
    env: CODECOV_TOKEN="c54d90f6-f88b-4d81-a284-2c97f6c32161"
    script: pytest --cov=example --cov-config=build/.coveragerc --cov-fail-under 60
    after_success: codecov
  - name: Test with Python 3.7.2 on macOS
    os: osx
    osx_image: xcode10.2
    language: shell
    before_install: pip3 install --upgrade pip
  - name: Test with Python 3.7.3 on Windows
    os: windows
    language: shell
    before_install: choco install python
    env: PATH=/c/Python37:/c/Python37/Scripts:$PATH
  
  - stage: quality
    name: Analyse code and check style with Python 3.6 on Linux
    addons:
      sonarcloud:
        organization: "chriskn"
        token:
          secure: "5e7c897319dd115d419123b160392b2978786914"
    install:
    - pip install black
    - pip install pylint
    - pip install -r requirements.txt
    script:
    - python -m pylint example --rcfile build/.pylintrc
    - black example --diff --check
    - sonar-scanner -Dproject.settings=build/sonar-project.properties

  - stage: docs
    install: pip install pdoc
    script: pdoc example --html --overwrite

notifications:
  email:
    on_success: change
    on_failure: always
